<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html, #container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=TCgR2Y0IGMmPR4qteh4McpXzMyYpFrEx"></script>
    <title>地图展示</title>
</head>
<body>
    <div id="container"></div>
</body>
</html>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMap.Map("container");    // 创建Map实例
    map.centerAndZoom(new BMap.Point(113.140761, 23.033974), 17);  // 初始化地图,设置中心点坐标和地图级别
    //添加地图类型控件
    map.addControl(new BMap.MapTypeControl({
        mapTypes: [
            BMAP_NORMAL_MAP,
            BMAP_HYBRID_MAP
        ]
    }));
    map.addControl(new BMap.ScaleControl());
    map.addControl(new BMap.NavigationControl());
    map.addControl(new BMap.OverviewMapControl());
    //map.addControl(new BMap.GeolocationControl());
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    var uavList = [];
    var blockGrid = {};
    function gridInit(opt) {
        //初始化网格
        if (!opt) opt = {};
        if (!opt.sideLength) opt.sideLength = 10;//默认边长10米，地图比例尺约1米约等于0.00001经纬度
        if (!opt.blockList) opt.blockList = [];//网格列表。
        if (!opt.colorBegin) opt.colorBegin = "fff";
        if (!opt.colorEnd) opt.colorEnd = "000";
        if (!opt.opacity) opt.opacity = 1;
        if (!opt.dataName) opt.dataName = "";
        if (!opt.maxValue) opt.maxValue = 100;
        if (!opt.minValue) opt.minValue = 0;
        blockGrid.options = opt;
        blockGrid.blocks = [];
    }

    function gridRefresh() {
        var points = [];
        uavList.forEach(uav => points = points.concat(uav.marker.pathPoint));
        var opt = blockGrid.options;
        gridClear();
        points.forEach(point => { //填充点数据到格子里
            if (!opt.firstPoint) opt.firstPoint = point;
            var block = blockGrid.blocks.find(block => isInBlock(block.center, opt.sideLength, point));
            if (!block) {
                block = createBlock(blockGrid.firstPoint, opt.sideLength, point);
            } else {
                block.points.push(point);
            }
        });
        blockGrid.blocks.forEach(block => {
            var sum = 0;
            block.points.forEach(point => {
                point.data[dataName]
            })
        });
    }
    function gridClear() {
        blockGrid.blocks.forEach(o => {
            map.removeOverlay(o.polygon);
        });
        blockGrid.blocks = [];
    }

    function createBlock(center, sideLength, point) {
        var offset = sideLength / 2 * 0.00001;//计算偏移经纬度。
        var lng = center.lng + offset * Math.round((point.lng - center.lng) / offset);
        var lat = center.lat + offset * Math.round((point.lat - center.lat) / offset)
        var center = new BMap.Point(lng, lat);
        return {
            center,
            polygon: new BMap.Polygon(),
            points: [point]
        };
    }

    function isInBlock(center, sideLength, point) {
        //块中心点，块边长，当前点是否在块里面。
        var offset = sideLength / 2 * 0.00001;//计算偏移经纬度。
        return point.lng > (center.lng - offset) &&
            point.lng < (center.lng + offset) &&
            point.lat > (center.lat - offset) &&
            point.lat > (center.lat + offset);
    }



    function uavAdd(name, lng, lat, data) {
        uav(name, null, () => {
            var point = new BMap.Point(lng, lat);
            point.data = data;
            var icon = new BMap.Icon("marker.png", new BMap.Size(30, 20));
            var uav = { name: name, marker: new BMap.Marker(point, { icon: icon }), pathPoint: [point] };
            uavList.push(uav);
            map.addOverlay(uav.marker);
        });
    }
    function uav(name, exist, notExist) {
        var uav = uavList.find(o => o.name == name);
        if (uav) {
            if (exist) {
                exist(uav);
            } else {
                console.log("uav named :%s already existed", name)
            }
        } else {
            if (notExist) {
                notExist();
            } else {
                console.log("uav named :%s not found", name)
            }
        }
    }
    function uavMove(name, lng, lag, data) {
        uav(name, o => {
            var point = new BMap.Point(lng, lag);
            point.data = data;
            o.pathPoint.push(point);
            o.marker.setPosition(point);
        });
    }
    function uavShowPath(name) {
        uav(name, o => {
            uavHidePath(name);
            var line = new BMap.Polyline(o.pathPoint,
                {
                    enableClicking: false,
                    strokeWeight: 3,
                    strokeColor: "red",
                    strokeStyle: "dashed",
                    strokeOpacity: 0.5
                });
            o.pathLine = line;
            map.addOverlay(line);
        });
    }
    function uavHidePath(name) {
        uav(name, o => {
            if (o.pathLine) {
                map.removeOverlay(o.pathLine);
                o.pathLine = null;
            }
        });
    }
    function uavRemove(name) {
        var i = -1;
        uavList.forEach((o, index) => {
            if (o.name == name) {
                map.removeOverlay(o.marker);
                if (o.pathLine) {
                    map.removeOverlay(o.pathLine);
                }
                i = index;
            }
        });
        if (i != -1) {
            uavList.splice(i, 1);
        }
    }

    function test() {
        var name = "uav1";
        var point = {
            lng: 113.140074,
            lat: 23.033494,
            direct: 1,
        }
        uavAdd(name, point.lng, point.lat);
        setInterval(p => {
            console.log("lng:%f,lat:%f", p.lng, p.lat);
            p.lng += 0.0001 * p.direct
            if (p.lng > 113.145 || p.lng < 113.14) {
                p.direct *= -1;
                p.lat += 0.0003;
            }
            uavMove(name, p.lng, p.lat);
            uavShowPath(name);
        }, 100, point);
    }
</script>
